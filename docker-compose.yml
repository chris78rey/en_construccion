# Stack: portal-da-tica
# Fecha: 2026-02-06
# Descripción: Docker Compose de PRODUCCIÓN para la página estática autocontenida.
# - Construye una imagen desde el contexto `web/` (multi-stage Dockerfile recomendado).
# - No mapea puertos del host (Traefik/Coolify gestionan el enrutamiento por subdominio).
# - Servicio único: `web`. Escucha internamente en 8080 y expone solo ese puerto.
#
# Reglas cumplidas:
# - No `ports:` públicos.
# - `restart: unless-stopped`
# - `expose: "8080"` (puerto interno documentado).
# - Sin volumenes persistentes (sitio estatico autocontenido en la imagen).
# - Healthcheck incluido.
# - Imagen con tag fijo (no `latest`).
#
version: "3.9"

services:
  web:
    # Build desde el contexto `web/`. Asegurate de tener un `web/Dockerfile` que
    # copie los assets y sirva estaticos con un servidor ligero (NGINX recomendado).
    build:
      context: ./web
      dockerfile: Dockerfile
    image: da-tica_portal_web:1.0.0
    restart: unless-stopped
    # Puerto interno que Traefik/Coolify deben detectar
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

# ---------------------------------------------------------
# Notas post-despliegue (leer)
# ---------------------------------------------------------
# Puerto interno que Coolify/Traefik debe detectar:
# - 8080
#
# Pasos manuales recomendados antes de publicar:
# 1) Añadir un `web/Dockerfile` que haga un build multi-stage:
#    - Stage build: instalar dependencias, compilar assets (si usás bundlers).
#    - Stage final: copiar contenido estático a un servidor ligero (nginx:alpine) o a la imagen node que sirva estáticos.
# 2) Probar localmente la build:
#    docker compose -f en_construccion/docker-compose.yml build
#    docker compose -f en_construccion/docker-compose.yml up -d
#    (Nota: en local probablemente necesites una configuración de testing distinta ya que no hay Traefik)
# 3) Subir a repo y crear Stack en Coolify apuntando a este `docker-compose.yml`.
#    - Branch: main (o el que uses)
#    - Puerto interno: 8080
#    - Variables en la UI: (ninguna requerida para este servicio)
#    - Asignar subdominio (ej. portal.da-tica.com). Coolify/Traefik gestionará certificados TLS automáticamente.
#
# Checklist final:
# - ¿No hay `ports:` públicos en este compose? Sí.
# - ¿La app escucha en 0.0.0.0:8080? Asegurate en el Dockerfile / servidor.
# - ¿Healthcheck presente? Sí.
# - ¿Imagen sin tag `latest`? Sí.
#
# Notas operativas:
# - NO incluir secrets en el compose. Usar las variables de Coolify.
# - Si en producción preferís servir estáticos con NGINX, modifica el Dockerfile para copiar el `dist/` a /usr/share/nginx/html y exponer internamente 8080.
# ---------------------------------------------------------
