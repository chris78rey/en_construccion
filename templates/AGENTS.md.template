# PROJECT KNOWLEDGE BASE (PLANTILLA AGN√ìSTICA)

**Generated:** {FECHA}
**Branch:** main  
**Commit:** {COMMIT_HASH}

---

## OVERVIEW

Portal/Aplicaci√≥n desplegable en **entorno de producci√≥n con proxy inverso gestionado** (Coolify + Traefik, Kubernetes, Docker Swarm, etc.) usando `docker-compose.yml` como fuente √∫nica de verdad para orquestaci√≥n y enrutamiento.

**Punto clave:** En este proyecto, `docker-compose.yml` **no es solo contenedores**, es tambi√©n **configuraci√≥n de routing**. Los labels de proxy inverso son obligatorios.

---

## STRUCTURE

```
./
‚îú‚îÄ‚îÄ docker-compose.yml                 # ‚ö†Ô∏è CR√çTICO: Orquestaci√≥n + routing via labels
‚îú‚îÄ‚îÄ .env.example                       # Variables de entorno (no commitear .env)
‚îú‚îÄ‚îÄ .gitignore                         # Ignorar credenciales, vol√∫menes, .env local
‚îú‚îÄ‚îÄ .opencode/
‚îÇ   ‚îî‚îÄ‚îÄ skills/
‚îÇ       ‚îî‚îÄ‚îÄ docker-compose-production/ # Skill: plantilla y validaci√≥n
‚îÇ           ‚îî‚îÄ‚îÄ SKILL.md
‚îú‚îÄ‚îÄ {servicio1}/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ {config-files}
‚îÇ   ‚îî‚îÄ‚îÄ {source-code}
‚îú‚îÄ‚îÄ {servicio2}/
‚îÇ   ‚îî‚îÄ‚îÄ (similar a servicio1)
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT.md                 # Gu√≠a de despliegue
‚îÇ   ‚îú‚îÄ‚îÄ TROUBLESHOOTING.md            # Debugging com√∫n
‚îÇ   ‚îî‚îÄ‚îÄ ARCHITECTURE.md               # Diagrama y explicaci√≥n
‚îú‚îÄ‚îÄ instr.md                          # Instrucciones consolidadas para agentes IA
‚îî‚îÄ‚îÄ README.md                         # Documentaci√≥n usuario
```

---

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| **Despliegue en producci√≥n** | `docker-compose.yml` | Labels obligatorios para proxy; sin `ports:` |
| **Definici√≥n de servicios** | `docker-compose.yml` (servicios) | Im√°genes con versi√≥n fija; `restart: unless-stopped` |
| **Variables de entorno** | `.env.example` ‚Üí copiar a `.env` (no commitar) | No hardcodear credenciales |
| **Configuraci√≥n de routing** | `docker-compose.yml` (labels) | Traefik/proxy lee labels; define HOST/PATH/TLS |
| **Validaci√≥n antes de deploy** | Skill: `docker-compose-production` | Checklist de seguridad, sintaxis, routing |
| **Debugging de conectividad** | Skill: `docker-compose-production` (secci√≥n 7) | Si "502 Bad Gateway", probablemente labels |
| **Arquitectura y decisiones** | `docs/ARCHITECTURE.md` | Por qu√© se hizo as√≠ |

---

## CONVENTIONS & RULES (OBLIGATORIAS)

### ‚úÖ REGLAS POSITIVAS (QU√â HACER)

1. **Labels para Proxy Inverso:**
   - Cada servicio publicado en internet requiere labels de Traefik/proxy.
   - Estructura obligatoria:
     - `traefik.enable=true`
     - `traefik.docker.network={red}`
     - Router: `traefik.http.routers.{nombre}.rule=Host(\`...\`)`
     - Servicio: `traefik.http.services.{nombre}.loadbalancer.server.port=...`
     - TLS: `traefik.http.routers.{nombre}.tls=true`
     - Redirecci√≥n HTTP‚ÜíHTTPS: middleware + router http

2. **Versionado de Im√°genes:**
   - Usar versiones fijas: `nginx:1.26-alpine`, `postgres:16-alpine`
   - NUNCA usar `latest`

3. **Puertos:**
   - Usar `expose:` (solo documentaci√≥n para proxy)
   - NUNCA usar `ports:` en servicios web
   - Comunicaci√≥n interna por nombre de servicio: `http://api:8000`

4. **Persistencia:**
   - Vol√∫menes nombrados para DBs, uploads, logs
   - No commitear datos en la imagen
   - `volumes:` section al final del compose

5. **Healthchecks:**
   - Obligatorio en servicios cr√≠ticos (DB, API)
   - Usar binarios presentes en la imagen (ej. `wget` en Alpine)
   - `depends_on` con `condition: service_healthy`

6. **Variables de Entorno:**
   - Definir en `.env.example` (commitar)
   - Variables en `environment:` como `${VAR}`
   - Nunca en el compose ni en labels

7. **Redes:**
   - Red interna nombrada (ej. `backend`, `app`)
   - `external: true/false` seg√∫n orquestador
   - Todos los servicios en la misma red

8. **Reinicio Autom√°tico:**
   - `restart: unless-stopped` en producci√≥n
   - Permite recuperaci√≥n sin intervenci√≥n manual

---

### üö´ PROHIBICIONES ABSOLUTAS

1. **NUNCA** mapear puertos del host en servicios web ‚Üí Proxy lo gestiona
2. **NUNCA** usar `latest` tag ‚Üí Cambios inesperados
3. **NUNCA** hardcodear credenciales ‚Üí Riesgo de seguridad
4. **NUNCA** usar `network_mode: host` ‚Üí Impide service discovery
5. **NUNCA** exponer bases de datos al host ‚Üí Solo acceso interno
6. **NUNCA** omitir labels en servicios p√∫blicos ‚Üí Proxy no sabe rutear
7. **NUNCA** configurar Traefik manualmente en producci√≥n ‚Üí Lo gestiona el orquestador

---

## ANTI-PATTERNS (APRENDIZAJES)

### El Fallo Silencioso: Labels Ausentes o Malformados

**S√≠ntoma:** "Mi contenedor corre pero dice `502 Bad Gateway`"

**Causa:** El proxy inverso no tiene instrucciones (labels) sobre c√≥mo rutear al contenedor.

**Soluci√≥n:** Verificar:
```bash
docker inspect {container} | grep -A 20 '"Labels"'
```

Los labels deben incluir:
- `traefik.enable=true`
- Router con regla de host/path
- Servicio con puerto correcto
- TLS configurado

---

## DEPLOYMENT CHECKLIST

Antes de desplegar (producci√≥n o staging):

- ‚úÖ `docker compose config` sin errores
- ‚úÖ Todas las im√°genes tienen versi√≥n fija (no `latest`)
- ‚úÖ Credenciales en `.env`, no en compose
- ‚úÖ Servicios p√∫blicos tienen labels completos
- ‚úÖ Bases de datos SIN labels
- ‚úÖ Healthchecks presentes
- ‚úÖ Vol√∫menes nombrados para persistencia
- ‚úÖ `restart: unless-stopped` en servicios cr√≠ticos
- ‚úÖ Redes correctamente configuradas
- ‚úÖ `.env.local` y credenciales est√°n en `.gitignore`
- ‚úÖ DNS/Cloudflare apunta al proxy
- ‚úÖ TLS/HTTPS configurado en labels

---

## COMMON ISSUES & SOLUTIONS

### "502 Bad Gateway"

**Orden de verificaci√≥n:**
1. Labels presentes y correctamente formateados ‚Üí `docker inspect`
2. Puerto interno coincide con `expose:` ‚Üí Config del servicio
3. `traefik.docker.network` coincide con `networks:` ‚Üí Mismo nombre
4. Contenedor responde localmente ‚Üí `docker exec ... curl http://127.0.0.1:PUERTO`

### "Connection Refused"

**Posibles causas:**
- Puerto interno es 0.0.0.0 en la app (no solo localhost)
- Puerto en `expose:` no coincide con donde escucha la app
- App a√∫n iniciando (comprobar healthcheck)

### "DNS not resolving"

- Verificar registros en DNS (Cloudflare, Route53, etc.)
- Proxy debe estar escuchando en la IP correcta
- Dominio debe apuntar al proxy, no al container directamente

### "Logs son densos / No entiendo qu√© pas√≥"

- Revisar logs del proxy: `docker logs {proxy-container}`
- Revisar logs del servicio: `docker logs {service-container}`
- Activar debug en variables de entorno si existe

---

## SKILLS AVAILABLE

Este proyecto usa **Skills en OMO** para operaciones comunes:

1. **`docker-compose-production`**
   - Plantilla agn√≥stica para docker-compose
   - Validaci√≥n de labels
   - Checklist pre-deploy
   - Ejemplos de escenarios reales
   - Debugging de routing

   **Invocar:** Cuando trabajes con docker-compose o tengas problemas de conectividad.

---

## ENVIRONMENT VARIABLES

**Archivo:** `.env` (copiar de `.env.example`, no commitar)

Categor√≠as principales:

### Infraestructura
- `PROXY_NETWORK=app` ‚Äî Nombre de red para proxy
- `DOCKER_REGISTRY=registry.ejemplo.com` ‚Äî Si usas registry privado

### Base de Datos
- `DB_NAME={nombre-db}`
- `DB_USER={usuario}`
- `DB_PASSWORD={contrase√±a-fuerte}` ‚ö†Ô∏è Cambiar en producci√≥n

### Aplicaci√≥n
- `LOG_LEVEL=info` (info, debug, warn, error)
- `SECRET_KEY={clave-aleatoria}` ‚ö†Ô∏è Cambiar en producci√≥n
- `ADMIN_USER={admin-username}` ‚ö†Ô∏è Cambiar en producci√≥n
- `ADMIN_PASSWORD={admin-password}` ‚ö†Ô∏è Cambiar en producci√≥n

### Dominio y SSL
- `DOMAIN_NAME=ejemplo.com`
- `LE_EMAIL=admin@ejemplo.com` ‚Äî Para Let's Encrypt

---

## NOTES FOR AI AGENTS

Cuando trabajes en este proyecto:

1. **Siempre revisa el Skill `docker-compose-production`** si vas a:
   - Crear o modificar `docker-compose.yml`
   - A√±adir servicios p√∫blicos (con labels)
   - Validar antes de deploy

2. **Si hay problema de conectividad ("502 Bad Gateway"):**
   - Primero piensa: "¬øfaltan labels o est√°n malformados?"
   - Valida con `docker inspect` y `docker compose config`

3. **Labels son la puente entre contenedores y proxy:**
   - Sin labels = proxy no sabe c√≥mo rutear
   - Es como una direcci√≥n sin n√∫mero de casa

4. **Desarrollo local vs. Producci√≥n:**
   - Local: puedes usar `docker compose` simple
   - Producci√≥n: labels son obligatorios

5. **Cuando generes docker-compose:**
   - Estructura: servicios ‚Üí vol√∫menes ‚Üí redes
   - No olvides healthchecks en DBs
   - No olvides labels en servicios p√∫blicos
   - Documenta variables en `.env.example`

---

## REFERENCES

- [Docker Compose Specification](https://github.com/compose-spec/compose-spec)
- [Traefik Docker Provider](https://docs.traefik.io/providers/docker/)
- [Docker Labels Best Practices](https://docs.docker.com/config/labels-custom-metadata/)
- Skill Local: `.opencode/skills/docker-compose-production/SKILL.md`

---

## CHANGELOG

| Versi√≥n | Fecha | Cambio |
|---------|-------|--------|
| 1.0 | {FECHA} | Versi√≥n agn√≥stica inicial; √©nfasis en labels obligatorios |