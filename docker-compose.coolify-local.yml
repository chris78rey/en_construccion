# Modo: üß™ MODO LOCAL ‚Äî Simulaci√≥n de Coolify (Traefik local)
# Objetivo: reproducir localmente el comportamiento que tendr√° en Coolify/Traefik sin cambios estructurales.
# Modificaci√≥n: permitir acceso usando http://localhost (puerto alternativo) sin necesidad de editar /etc/hosts.
#
# NOTA: Para evitar conflictos con servicios que ya usen el puerto 80/443 en el host,
# este compose mapea Traefik a puertos alternativos locales: 8081 (HTTP) y 8443 (HTTPS).
# Acceso recomendado desde el navegador:
#  - http://localhost:8081  (se enruta al servicio `web` gracias a la regla HostRegexp)
#  - Traefik dashboard: http://localhost:8080/dashboard/ (puerto dashboard mapeado)
#
version: "3.8"

services:
  traefik-local:
    image: traefik:2.10.1
    container_name: traefik-local
    restart: unless-stopped
    command:
      - --api.insecure=true
      - --providers.docker=false
      - --providers.file.filename=/etc/traefik/dynamic/dynamic.yml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
    ports:
      - "8081:80"    # HTTP local (evita colisiones con puertos del host)
      - "8443:443"   # HTTPS local (opcional)
      - "8080:8080"  # Traefik dashboard (inseguro) - s√≥lo para desarrollo
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_conf:/etc/traefik
      - ./traefik/dynamic.yml:/etc/traefik/dynamic/dynamic.yml:ro
    networks:
      - traefik
    labels:
      # Dashboard accesible en http://localhost:8080/dashboard/
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`) || HostRegexp(`{host:localhost(:[0-9]+)?}`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/dashboard/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  web:
    image: node:18.20.1-alpine3.18
    container_name: portal_web_local
    restart: unless-stopped
    user: node
    env_file:
      - .env.local
    environment:
      - PORT=${PORT:-8080}
      - NODE_ENV=${NODE_ENV:-production}
    expose:
      - "8080"
    volumes:
      - ./web:/home/node/app
    networks:
      - traefik
    labels:
      # Allow routing for:
      #  - portal.localhost (if you added /etc/hosts)
      #  - localhost (with optional port) so you can visit http://localhost:8081
      - "traefik.enable=true"
      - "traefik.http.routers.portal.rule=Host(`portal.localhost`) || HostRegexp(`{host:localhost(:[0-9]+)?}`)"
      - "traefik.http.routers.portal.entrypoints=web"
      - "traefik.http.services.portal.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:8080',res=>process.exit(res.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s
    command: ["node","-e","const http=require('http'), fs=require('fs'), path=require('path'); const port=process.env.PORT||8080; http.createServer((req,res)=>{ const p=path.join('/home/node/app', req.url==='/'?'/index.html':req.url); fs.readFile(p,(e,d)=>{ if(e){ res.writeHead(404,{'Content-Type':'text/plain'}); res.end('Not Found'); } else { const ctype = p.endsWith('.js') ? 'application/javascript' : p.endsWith('.html') ? 'text/html' : 'text/plain'; res.writeHead(200,{'Content-Type':ctype}); res.end(d); } }); }).listen(port,'0.0.0.0');"]

volumes:
  web_static:
  traefik_conf:

networks:
  traefik:
    driver: bridge

# Instrucciones r√°pidas:
# 1) Levantar:
#      docker compose -f docker-compose.coolify-local.yml up -d --build
# 2) Abrir en el navegador:
#      http://localhost:8081
#    (o si prefieres usar un Virtual Host: a√±adir 127.0.0.1 portal.localhost en /etc/hosts y abrir http://portal.localhost)
# 3) Dashboard Traefik (dev): http://localhost:8080/dashboard/