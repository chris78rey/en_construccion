# Modo: üß™ MODO LOCAL ‚Äî Simulaci√≥n de Coolify (Traefik local)
# Archivo: docker-compose.coolify-local.yml
# Objetivo: reproducir localmente el comportamiento que tendr√° en Coolify/Traefik sin cambios estructurales.
# - Plan breve:
#   Servicios:
#     1) traefik-local  -> proxy inverso local (Traefik v2), expone puertos 80/443/8080 en la m√°quina local para pruebas.
#     2) web            -> aplicaci√≥n est√°tica JS (misma estructura que en producci√≥n). Escucha en 0.0.0.0:8080, solo `expose` (no `ports:`).
#   Relaciones:
#     - Traefik enruta tr√°fico al servicio `web` seg√∫n labels (Host `portal.localhost`).
#   Notas de dise√±o:
#     - Mantener la misma estructura de servicio `web` que usar√°s en producci√≥n: mismo nombre, mismo puerto interno (8080), mismo volumen `web_static`.
#     - No se hardcodean credenciales.
#
# Entorno de prueba:
#  - A√±ade la entrada a /etc/hosts: 127.0.0.1  portal.localhost
#  - Acceso desde navegador: http://portal.localhost
#
# Deliverables:
#  - Este docker-compose para local.
#  - Archivo de ejemplo .env.local (ver abajo en comentarios). El compose referencia `.env.local` para simular variables.
#
# Formato: sigue las reglas del prompt unificado (sin `ports:` en el servicio `web`, restart policy, expose, healthcheck, volumes).
#
version: "3.8"

services:
  traefik-local:
    image: traefik:2.10.1
    container_name: traefik-local
    restart: unless-stopped
    command:
      - --api.insecure=true                          # dashboard accesible en :8080 localmente (solo para desarrollo)
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false    # habilitar solo servicios con label traefik.enable=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # (No ACME/Let‚Äôs Encrypt for local mode; Coolify gestionar√° TLS en producci√≥n)
    ports:
      - "80:80"    # acceso HTTP local (portal.localhost)
      - "443:443"  # opcional: para probar HTTPS si configuras certificados locales
      - "8080:8080" # Traefik dashboard (inseguro) - solo para testing
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_conf:/etc/traefik
    networks:
      - traefik
    labels:
      # Opcional: exponer dashboard por host (√∫til si quieres consultar panel)
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/dashboard/" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  web:
    # Mantener la misma estructura que el stack de producci√≥n:
    image: node:18.20.1-alpine3.18
    container_name: portal_web_local
    restart: unless-stopped
    user: node
    env_file:
      - .env.local
    environment:
      # Valores por defecto (puede sobrescribirse en .env.local)
      - PORT=${PORT:-8080}
      - NODE_ENV=${NODE_ENV:-production}
    expose:
      - "8080"   # Puerto interno (mismo que en producci√≥n)
    volumes:
      - web_static:/home/node/app
    networks:
      - traefik
    labels:
      # Labels Traefik (id√©nticos a los que usar√° Coolify en producci√≥n)
      - "traefik.enable=true"
      - "traefik.http.routers.portal.rule=Host(`portal.localhost`)"
      - "traefik.http.routers.portal.entrypoints=web"
      - "traefik.http.services.portal.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:8080',res=>process.exit(res.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Comportamiento de arranque: si el volumen est√° vac√≠o, crear un index.html autocontenido (igual que en producci√≥n)
    command: >
      sh -c '
        mkdir -p /home/node/app;
        if [ ! -f /home/node/app/index.html ]; then
          cat >/home/node/app/index.html <<'"'"'HTML'"'"';
          <!doctype html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Portal da-tica (local)</title></head><body><h1>Portal da-tica (local)</h1><p>Prueba local mediante Traefik. Hash-router y JS en el cliente.</p><script>(function(){document.body.appendChild(document.createElement('pre')).textContent='Ahora: '+new Date();})();</script></body></html>
          HTML
        fi;
        chown -R node:node /home/node/app || true;
        exec node -e "const http=require('http'), fs=require('fs'), path=require('path'), port=process.env.PORT||8080; http.createServer((req,res)=>{ const p=path.join('/home/node/app', req.url==='/'?'/index.html':req.url); fs.readFile(p,(e,d)=>{ if(e){ res.writeHead(404,{'Content-Type':'text/plain'}); res.end('Not Found') } else { const ctype = p.endsWith('.js') ? 'application/javascript' : p.endsWith('.html') ? 'text/html' : 'text/plain'; res.writeHead(200,{'Content-Type':ctype}); res.end(d) } }) }).listen(port,'0.0.0.0')"
    # Nota: no se usan 'ports:' aqu√≠ para mantener paridad con producci√≥n

volumes:
  web_static:
  traefik_conf:

networks:
  traefik:
    driver: bridge

# ----------------------------
# .env.local (ejemplo) - crea este archivo al lado del compose
# ----------------------------
# Contenido sugerido para `.env.local` (NO inclu√≠do autom√°ticamente, cr√©alo en la misma carpeta):
#
# PORT=8080
# NODE_ENV=development
#
# Explicaci√≥n:
# - PORT: puerto interno en el contenedor (debe ser 8080 para mantener paridad con producci√≥n).
# - NODE_ENV: development/production seg√∫n quieras probar.
#
# ----------------------------
# Instrucciones de prueba local (resumen)
# ----------------------------
# 1) A√±ade al /etc/hosts:
#      127.0.0.1  portal.localhost traefik.localhost
# 2) Crear `.env.local` en el mismo directorio con las variables sugeridas arriba.
# 3) Levantar stack:
#      docker compose -f docker-compose.coolify-local.yml up -d
# 4) Verificar:
#      - Traefik dashboard: http://traefik.localhost:8080/dashboard/
#      - App: http://portal.localhost
#      - Healthchecks: docker ps + docker inspect --format '{{.State.Health.Status}}' <container>
#
# ----------------------------
# Notas post-despliegue y checklist de validaci√≥n
# ----------------------------
# - ¬øFunciona local con Traefik? -> Debes poder acceder a http://portal.localhost (s√≠ si seguiste pasos).
# - ¬øNo usa puertos p√∫blicos en el servicio `web`? -> Correcto (no hay `ports:` en `web`).
# - ¬øFuncionar√° igual en Coolify? -> S√≠: mismo nombre de servicio `web`, mismo puerto interno (8080), mismas labels equivalentes que Coolify usar√° (en Coolify no se usan labels, pero la organizaci√≥n de puertos/vol√∫menes/healthchecks es id√©ntica).
# - ¬øCumple Cloudflare ‚Üí Coolify ‚Üí contenedor? -> S√≠: en producci√≥n Coolify/Traefik reemplazar√° el Traefik local y gestionar√° TLS/HTTP, sin cambios en el servicio `web`.
#
# Si quieres que adem√°s genere autom√°ticamente un `docker-compose.override.yml` o un README con instrucciones paso-a-paso m√°s detalladas, d√≠melo y lo agrego.